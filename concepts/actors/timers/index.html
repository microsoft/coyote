<!DOCTYPE html>
<html lang="en">
<head>
  
  
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    
    <link rel="canonical" href="https://microsoft.github.io/coyote/concepts/actors/timers/">
    <link rel="shortcut icon" href="/coyote/img/favicon.ico">
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Using timers in actors - Coyote</title>
    <link href="/coyote/css/bootstrap-3.3.7.min.css" rel="stylesheet">
    <link href="/coyote/css/font-awesome-4.7.0.css" rel="stylesheet">
    <link href="/coyote/css/base.css" rel="stylesheet">
    <link rel="stylesheet" href="/coyote/css/highlight.css">
    <link href="../../../css/main.css" rel="stylesheet">
    <link href="../../../css/player-controls.css" rel="stylesheet">
    <link href="../../../css/syntax.css" rel="stylesheet">
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->

    <script src="/coyote/js/jquery-3.2.1.min.js"></script>
    <script src="/coyote/js/bootstrap-3.3.7.min.js"></script>
    <script src="/coyote/js/highlight.pack.js"></script>
    <script src="https://consentdeliveryfd.azurefd.net/mscc/lib/v2/wcp-consent.js"></script>
    
    <base target="_top">
    <script>
      var base_url = '/coyote/';
      var is_top_frame = false;
        
        var pageToc = [
          {title: "Using timers in actors", url: "#_top", children: [
          ]},
          {title: "Implementation notes", url: "#implementation-notes", children: [
          ]},
        ];

    </script>
    <script src="/coyote/js/base.js"></script>
      <script src="../../../assets/js/analytics.js"></script>
      <script src="../../../assets/js/plugins.js"></script>
      <script src="../../../assets/js/animate_trace.js"></script>
      <script src="../../../assets/js/animation.js"></script>
      <script src="../../../assets/js/progress_bar.js"></script>
      <script src="../../../assets/js/trace_model.js"></script>
      <script src="../../../assets/js/main.js"></script>

</head>

<body>
<script>
if (is_top_frame) { $('body').addClass('wm-top-page'); }
</script>

<div id="cookie-banner"></div>


<div class="wrapper wm-page-content">
  <div class="container-fluid">
    <a name="_top"></a>
      

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../event-groups/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../event-groups/" class="btn btn-xs btn-link">
        Event groups
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../termination/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../termination/" class="btn btn-xs btn-link">
        Actor termination
      </a>
    </div>
    
  </div>

      

      <h2 id="using-timers-in-actors">Using timers in actors</h2>
<p>The Coyote actor programming model has built-in support for timers. Timers are themselves a type of <code>Actor</code> that
send a <code>TimerElapsedEvent</code> upon timeout to the actor that created the timer. Timers are handy for
modeling a common type of asynchronous behavior in distributed systems, so you can find more bugs in
your code relating to how it deals with the uncertainty of various kinds of timeouts.</p>
<p>Timers provide a once only timeout event or a periodic timeout, which can continually send such
events on a user-defined interval until they are stopped.</p>
<p>To make use of timers, you must include the <code>Microsoft.Coyote.Actors.Timers</code> namespace. You can
start a non-periodic timer using the function <code>StartTimer</code>.</p>
<pre><code class="language-csharp">TimerInfo StartTimer(TimeSpan startDelay, TimerElapsedEvent customEvent)
</code></pre>
<p><code>StartTimer</code> takes as argument:
1. <code>TimeSpan startDelay</code>, which is the amount of time to wait before sending the timeout event.
2. <code>TimerElapsedEvent customEvent</code>, an optional custom event (of a user-specified subclass of
   <code>TimerElapsedEvent</code>) to raise instead of the default <code>TimerElapsedEvent</code>.</p>
<p><code>StartTimer</code> returns <code>TimerInfo</code>, which contains information about the created non-periodic timer.
The non-periodic timer is automatically disposed after it timeouts. You can also pass the
<code>TimerInfo</code> to the <code>StopTimer</code> method to manually stop and dispose the timer. The timer enqueues
events of type <code>TimerElapsedEvent</code> (or of a user-specified subclass of <code>TimerElapsedEvent</code>) in the
inbox of the actor that created it. The <code>TimerElapsedEvent</code> contains as payload, the same
<code>TimerInfo</code> returned during the timer creation. If you create multiple timers, then the <code>TimerInfo</code>
object can be used to distinguish the sources of the different <code>TimerElapsedEvent</code> events.</p>
<p>You can start a periodic timer using the function <code>StartPeriodicTimer</code>.</p>
<pre><code class="language-csharp">TimerInfo StartPeriodicTimer(TimeSpan startDelay, TimeSpan period, TimerElapsedEvent customEvent)
</code></pre>
<p><code>StartPeriodicTimer</code> takes as argument:
1. <code>TimeSpan startDelay</code>, which is the amount of time to wait before sending the first timeout
   event.
2. <code>TimeSpan period</code>, which is the time interval between timeout events.
3. <code>TimerElapsedEvent customEvent</code>, an optional custom event (of a user-specified subclass of
   <code>TimerElapsedEvent</code>) to raise instead of the default <code>TimerElapsedEvent</code>.</p>
<p>Periodic timers work similarly to normal timers, however you need to manually stop a periodic timer
using the <code>StopTimer</code> method if you want it to stop sending <code>TimerElapsedEvent</code> events. Note that
when an actor <a href="../termination/">halts</a>, it automatically stops and disposes all its periodic and
non-periodic timers.</p>
<p>A sample which demonstrates the use of such timers is provided in the <a href="https://github.com/microsoft/coyote/tree/main/Samples/Timers">Timers
Sample</a> on github, which is
explained in detail below.</p>
<p>First you need to declare on your Actor that it is expecting to receive the <code>TimerElapsedEvent</code> so
the class is defined like this:</p>
<pre><code class="language-csharp">[OnEventDoAction(typeof(TimerElapsedEvent), nameof(HandleTimeout))]
internal class Client : Actor
{
    ...
}
</code></pre>
<p>To kick things off the initialization method starts a non-periodic timer:</p>
<pre><code class="language-csharp">protected override Task OnInitializeAsync(Event initialEvent)
{
    Console.WriteLine(&quot;&lt;Client&gt; Starting a non-periodic timer&quot;);
    this.StartTimer(TimeSpan.FromSeconds(1));
    return base.OnInitializeAsync(initialEvent);
}
</code></pre>
<p>The <code>HandleTimeout</code> method then receives this timeout and starts a periodic timer as follows:</p>
<pre><code class="language-csharp">private void HandleTimeout(Event e)
{
    TimerElapsedEvent te = (TimerElapsedEvent)e;

    this.WriteMessage(&quot;&lt;Client&gt; Handling timeout from timer&quot;);

    this.WriteMessage(&quot;&lt;Client&gt; Starting a period timer&quot;);
    this.PeriodicTimer = this.StartPeriodicTimer(TimeSpan.FromSeconds(1), 
        TimeSpan.FromSeconds(1), new CustomTimerEvent());
}
</code></pre>
<p>In this case we use a <code>CustomTimerEvent</code> instead of the default <code>TimerElapsedEvent</code>, this custom event is defined as follows:</p>
<pre><code class="language-csharp">internal class CustomTimerEvent : TimerElapsedEvent
{
    /// &lt;summary&gt;
    /// Count of timeout events processed.
    /// &lt;/summary&gt;
    internal int Count;
}
</code></pre>
<p>This custom event makes it possible to route the period timeouts to a different handler using this on the actor class:</p>
<pre><code class="language-csharp">[OnEventDoAction(typeof(CustomTimerEvent), nameof(HandlePeriodicTimeout))]
</code></pre>
<p>In the HandlePeriodicTimeout method we count the number of timeouts and stop when we reach 3:</p>
<pre><code class="language-csharp">private void HandlePeriodicTimeout(Event e)
{
    this.WriteMessage(&quot;&lt;Client&gt; Handling timeout from periodic timer&quot;);
    if (e is CustomTimerEvent ce)
    {
        ce.Count++;
        if (ce.Count == 3)
        {
            this.WriteMessage(&quot;&lt;Client&gt; Stopping the periodic timer&quot;);
            this.StopTimer(this.PeriodicTimer);
        }
    }
}
</code></pre>
<p>Notice how we can cast the <code>Event</code> into our custom <code>CustomTimerEvent</code>, and we get the same instance
of <code>CustomTimerEvent</code> on each period call, so this way the <code>CustomTimerEvent</code> can contain useful
state, in this case the <code>Count</code>.</p>
<p>The output of this program is as follows:</p>
<pre><code class="language-xml">&lt;Client&gt; Starting a non-periodic timer
&lt;Client&gt; Handling timeout from timer
&lt;Client&gt; Starting a period timer
&lt;Client&gt; Handling timeout from periodic timer
&lt;Client&gt; Handling timeout from periodic timer
&lt;Client&gt; Handling timeout from periodic timer
&lt;Client&gt; Stopping the periodic timer
</code></pre>
<h2 id="implementation-notes">Implementation notes</h2>
<p>Note that timers are implemented differently depending on what mode your program is running in.
Normal &ldquo;production&rdquo; mode execution uses an optimized timer built on <code>System.Threading.Timer</code>.</p>
<p>Timers that run during systematic testing, however, are quite different and are implemented in a
<code>MockTimerActor</code> class.  This mock actually removes all concept of real time intervals, and replaces
that with a random decision to timeout or not to timeout.  This makes your test run much faster. But
it can also make your test see a lot more timeout events that you may be expecting.  This is good
for finding bugs, but can overwhelm the test with timeout events.  To reduce the number of timeouts
there is a <code>--timeout-delay</code> command line option on the <code>coyote test</code> tool.  This timeout delay is
given to the mock timer and it will only fire a timeout when <code>RandomInteger(delay) == 0</code>.  The
default value of <code>--timeout-delay</code> is 10, which means timeouts only fire once every 10 times the
timer gets scheduled by the systematic testing runtime.  This turns out to be a pretty good default
that stops your test from getting too overwhelmed by timeout events, but if you still see too many
timeout events in your test logs, then you can increase this number.</p>

    <br>
      

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../event-groups/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../event-groups/" class="btn btn-xs btn-link">
        Event groups
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../termination/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../termination/" class="btn btn-xs btn-link">
        Actor termination
      </a>
    </div>
    
  </div>

      <br>
  </div>
</div>

<footer class="wm-page-content">
  

<section class="footer-join pt-40 pb-80">
  <div class="container-fluid">
    <div class="row text-center">
      <div class="col-sm-8 col-sm-offset-2">
      </div>
    </div>
    <div class="row">
   </div>
  </div>
</section>
<section class="footer-dark pt-60">
  <div class="container-fluid">
    <div class="row">
      <div class="hidden-xs col-sm-5 col-lg-6">
        <a href="" title="homepage" class="logo-footer">
          <img src="/coyote/assets/images/icon.png" alt="Coyote">
        </a>
      </div>

      <div class="col-sm-2 col-xs-4 footer-dark-col">
        <nav>
          <h4>Coyote</h4>
          <ul class="list-unstyled">
            <li><a href="/coyote/">Home</a></li>
            <li><a href="/coyote/get-started/install/">Install</a></li>
            <li><a href="https://github.com/microsoft/coyote/"><i class="fa fa-github"></i>
GitHub</a></li>
          </ul>
        </nav>
      </div>

      <div class="col-sm-2 col-xs-4 footer-dark-col">
        <nav>
          <h4>Resources</h4>
          <ul class="list-unstyled">
            <li><a href="/coyote/tutorials/first-concurrency-unit-test/">Getting started</a></li>
            <li><a href="/coyote/tutorials/overview/">Tutorials</a></li>
            <li><a href="/coyote/ref/Microsoft.Coyote">API documentation</a></li>
          </ul>
        </nav>
      </div>

      <div class="col-sm-2 col-xs-4 footer-dark-col">
        <nav>
          <h4>Community</h4>
          <ul class="list-unstyled">
            <li><a href="https://github.com/microsoft/coyote/discussions"><i class="fa fa-github"></i>
GitHub</a></li>
            <li><a href="https://twitter.com/coyote_dev" target="_blank"><i class="fa fa-twitter"></i> Twitter</a></li>
            <li><a href="https://teams.microsoft.com/l/channel/19%3a1fe966b4fdc544bca648d89bf25c3c56%40thread.tacv2/General?groupId=7a6d8afc-c23d-4e5d-b9cb-9124118c0220&tenantId=72f988bf-86f1-41af-91ab-2d7cd011db47" target="_blank">Teams (Internal)</a></li>
          </ul>
        </nav>
      </div>
    </div>

    <div class="row footnote pt-50 pb-20">
      <div class="col-sm-12">
        <hr>
      </div>
      <div class="col-sm-7">
        <ul class="list-unstyled list-inline footnote-copy">
          <li><a href="https://go.microsoft.com/fwlink/?LinkId=521839" target="_blank">Privacy & Cookies</a></li>
          <li><a href="https://go.microsoft.com/fwlink/?linkid=2259814" target="_blank">Consumer Health Privacy</a></li>
          <li><a href="https://go.microsoft.com/fwlink/?LinkID=206977" target="_blank">Terms of Use</a></li>
          <li><a href="https://www.microsoft.com/en-us/legal/intellectualproperty/trademarks" target="_blank">Trademarks</a></li>
          <li><a href="https://github.com/microsoft/coyote/blob/main/LICENSE" target="_blank">License</a></li>
        </ul>
      </div>
      <div class="col-sm-5 text-right footnote-copy">
        <ul class="list-unstyled list-inline">
          <li><span id="copyright"></span></li>
          <li><a href="https://www.microsoft.com/" target="_blank"><img class="img-responsive" src="/coyote/assets/images/microsoft-logo.svg?v=3" alt="Microsoft">&nbsp;</a></li>
        </ul>
      </div>
    </div>
  </div>
</section>
</footer>


<script type="text/javascript">
    $(document).ready(function () {
      $('table').each(function () {
        $(this).addClass("table");
        $(this).addClass("table-bordered");
        $(this).addClass("table-striped");
        $(this).addClass("table-condensed");
      });

    });
</script>

</body>
</html>