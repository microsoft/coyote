<!DOCTYPE html>
<html lang="en">
<head>
  
  
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    
    <link rel="canonical" href="https://microsoft.github.io/coyote/concepts/specifications/">
    <link rel="shortcut icon" href="/coyote/img/favicon.ico">
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Program specifications - Coyote</title>
    <link href="/coyote/css/bootstrap-3.3.7.min.css" rel="stylesheet">
    <link href="/coyote/css/font-awesome-4.7.0.css" rel="stylesheet">
    <link href="/coyote/css/base.css" rel="stylesheet">
    <link rel="stylesheet" href="/coyote/css/highlight.css">
    <link href="../../css/main.css" rel="stylesheet">
    <link href="../../css/player-controls.css" rel="stylesheet">
    <link href="../../css/syntax.css" rel="stylesheet">
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->

    <script src="/coyote/js/jquery-3.2.1.min.js"></script>
    <script src="/coyote/js/bootstrap-3.3.7.min.js"></script>
    <script src="/coyote/js/highlight.pack.js"></script>
    <script src="https://consentdeliveryfd.azurefd.net/mscc/lib/v2/wcp-consent.js"></script>
    
    <base target="_top">
    <script>
      var base_url = '/coyote/';
      var is_top_frame = false;
        
        var pageToc = [
          {title: "Writing program specifications", url: "#_top", children: [
              {title: "Specifying safety properties", url: "#specifying-safety-properties" },
              {title: "Specifying liveness properties", url: "#specifying-liveness-properties" },
          ]},
        ];

    </script>
    <script src="/coyote/js/base.js"></script>
      <script src="../../assets/js/analytics.js"></script>
      <script src="../../assets/js/plugins.js"></script>
      <script src="../../assets/js/animate_trace.js"></script>
      <script src="../../assets/js/animation.js"></script>
      <script src="../../assets/js/progress_bar.js"></script>
      <script src="../../assets/js/trace_model.js"></script>
      <script src="../../assets/js/main.js"></script>

</head>

<body>
<script>
if (is_top_frame) { $('body').addClass('wm-top-page'); }
</script>

<div id="cookie-banner"></div>


<div class="wrapper wm-page-content">
  <div class="container-fluid">
    <a name="_top"></a>
      

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../actors/overview/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../actors/overview/" class="btn btn-xs btn-link">
        Overview
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../binary-rewriting/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../binary-rewriting/" class="btn btn-xs btn-link">
        Binary rewriting for systematic testing
      </a>
    </div>
    
  </div>

      

      <h2 id="writing-program-specifications">Writing program specifications</h2>
<p>Coyote makes it easy to design and express system-level specifications that can be asserted during
testing. Specifications come in two forms. <em>Safety</em> specifications assert that the system never
enters a <em>bad</em> state. <em>Liveness</em> specifications assert that the system eventually does something
<em>good</em>, that is, it asserts that the system is always able to make progress. These can be written
using a <code>Monitor</code>.</p>
<h3 id="specifying-safety-properties">Specifying safety properties</h3>
<p>Safety property specifications generalize the notion of source code assertions. A safety property
violation is a finite execution that leads a system to an erroneous state. Coyote provides an API
for writing assertions that specify safety properties that are local to a Coyote actor or task. In
the <code>Task</code> programming model, you should use <code>Specification.Assert</code> (see <a href="../../ref/Microsoft.Coyote.Specifications/Specification/">Specification
API</a>) and in the <code>Actor</code> programming model
the corresponding API is <code>Actor.Assert</code>. In addition, Coyote also provides a way to specify
<em>global</em> assertions that can describe the relationship across tasks or actors.</p>
<p>Coyote provides the notion of a <code>Monitor</code> (see <a href="../../ref/Microsoft.Coyote.Specifications/Monitor/">Monitor
API</a>). It is a special kind of actor that
can receive events but cannot send events to other actors. So it can only observe the execution of
a program but not influence it: a desirable property when writing specifications in code. A
<code>Monitor</code> is declared as follows:</p>
<pre><code class="language-csharp">using Microsoft.Coyote.Specifications;
class GlobalSpec : Monitor { ... }
</code></pre>
<p>The above code snippet declares a monitor named <code>GlobalSpec</code>. Unlike actors, monitors are not
explicitly instantiated. Instead, they need to be registered with the Coyote runtime:</p>
<pre><code class="language-csharp">ICoyoteRuntime runtime;
runtime.RegisterMonitor&lt;GlobalSpec&gt;();
</code></pre>
<p>There can only be one instance of a given monitor type. Communication with this monitor happens via
events:</p>
<pre><code class="language-csharp">ICoyoteRuntime runtime;
runtime.InvokeMonitor&lt;GlobalSpec&gt;(new CustomEvent(...));
</code></pre>
<p>Just like actors, monitors can have any number of fields, methods and states. The following is a
simple example of a monitor. Let&rsquo;s say that there are two actors <code>A</code> and <code>B</code> that maintain two
important variables called <code>x</code> and <code>y</code>, respectively. We want to assert that these two values are
always within a difference of <code>5</code> between each other. There is no one assert that we can write that
is local to <code>A</code> or <code>B</code> because both <code>x</code> and <code>y</code> live in different places. So we define a global
<code>Monitor</code> that accepts events as soon as a variable is updated. Then it keeps asserting their values
are within the required bound.</p>
<pre><code class="language-csharp">using Microsoft.Coyote.Specifications;

public class UpdatedXEvent : Monitor.Event
{
   public int value { get; private set; }
   public UpdatedXEvent(int value)
   {
         this.value = value;
   }
}

public class UpdatedYEvent : Monitor.Event
{
   public int value { get; private set; }

   public UpdatedYEvent(int value)
   {
         this.value = value;
   }
}

class GlobalSpec : Monitor
{
   // Current reading of x.
   int my_x;
   // Current reading of y.
   int my_y;

   [Start]
   [OnEntry(nameof(InitOnEntry))]
   [OnEventDoAction(typeof(UpdatedXEvent), nameof(UpdatedXAction))]
   [OnEventDoAction(typeof(UpdatedYEvent), nameof(UpdatedYAction))]
   class Init : State { }

   // Initialization.
   void InitOnEntry()
   {
     my_x = my_y = 0;
   }

   void UpdatedXAction(Event e)
   {
      my_x = (e as UpdatedXEvent).value;
      this.AssertSafety();
   }


   void UpdatedYAction(Event e)
   {
      my_y = (e as UpdatedYEvent).value;
      this.AssertSafety();
   }

   void AssertSafety()
   {
      this.Assert(Math.Abs(my_x - my_y) &lt;= 5);
   }
}
</code></pre>
<p>In general, a monitor maintains local state of its own that is modified in response to events
received from the program. This local state is used to maintain a history of the computation that is
relevant to the property being monitored. An erroneous global behavior is flagged via an assertion
on the private state of the safety monitor. Thus, a monitor cleanly separates the instrumentation
state required for specification (inside the monitor) from the program state (outside the monitor).</p>
<p>You can use monitors with the tasks programming model as well. Simply use
<code>Specification.RegisterMonitor</code> and <code>Specification.InvokeMonitor</code> instead of the corresponding APIs
in <code>ICoyoteRuntime</code>.  A <code>Task</code> program can still use an <code>ICoyoteRuntime</code> if it wants to, the static
methods are just provided as a convenience way to find the current <code>ICoyoteRuntime</code>.</p>
<h3 id="specifying-liveness-properties">Specifying liveness properties</h3>
<p>Liveness property specifications generalize the notion of <em>non-termination</em>. A liveness property
violation is an infinite trace that exhibits lack of progress. Let&rsquo;s explain this concept through an
example. Suppose that you are designing a replication protocol. The job of the protocol is to ensure
that your data is replicated on, say, three different storage nodes. When a storage node fails, the
protocol kicks in, reads the lost data from one of the alive replicas, and then creates a new
replica on a different storage node. A natural specification for this protocol is that <em>eventually</em>
it must establish three replicas for the data. In other words, it is unavoidable (on storage-node
failure) that there are less-than-required number of replicas, but in that case the protocol must
work towards creating the desired number of replicas again. A violation of this property is an
(infinite) execution where a storage node fails but the protocol is not able to create the third
replica, even when given an infinite amount of time. We keep talking about infinite behaviors here,
but let&rsquo;s come back to that later. First, let us see how we can write this property as a monitor.</p>
<p>A liveness monitor contains two special states: the <em>hot</em> and the <em>cold</em> state. The hot state
denotes a point in the execution where progress is required, but has not happened yet; e.g. a node
has failed, but a new one has not been created yet. A liveness monitor transitions to the hot state
when it is notified that the system must make progress. A liveness monitor leaves the hot state and
enters the cold state when it is notified that the system has progressed enough. An infinite
execution is erroneous if the liveness monitor stays in the hot state for an infinitely long period
of time. Consider the following example.</p>
<pre><code class="language-csharp">using Microsoft.Coyote.Specifications;

class UpEvent : Monitor.Event { }
class DownEvent : Monitor.Event { }

class LivenessMonitor : Monitor
{
  // current number of replicas alive.
  int alive = 0;

  [Start]
  [Hot]
  [OnEventDoAction(typeof(UpEvent),nameof(OnUp))]
  [OnEventDoAction(typeof(DownEvent),nameof(OnDown))]
  class NotEnoughReplicas : State { }


  [Cold]
  [OnEventDoAction(typeof(UpEvent),nameof(OnUp))]
  [OnEventDoAction(typeof(DownEvent),nameof(OnDown))]
  class EnoughReplicas : State { }

  // Notification that a new replica is up.
  void OnUp()
  {
     alive++;
     if (alive &gt;= 3)
     {
        this.RaiseGotoStateEvent&lt;EnoughReplicas&gt;();
     }
     else
     {
        this.RaiseGotoStateEvent&lt;NotEnoughReplicas&gt;();
     }
  }

  // Notification that a replica has gone down.
  void OnDown()
  {
     alive--;
     if (alive &gt;= 3)
     {
        this.RaiseGotoStateEvent&lt;EnoughReplicas&gt;();
     }
     else
     {
        this.RaiseGotoStateEvent&lt;NotEnoughReplicas&gt;();
     }
  }
}
</code></pre>
<p>This monitor has two states. It starts in a <em>hot</em> state <code>NotEnoughReplicas</code> and keeps track of the
number of replicas alive in the system. It stays in the <code>NotEnoughReplicas</code> state as long as this
number is below three, otherwise it transitions to the <em>cold</em> state <code>EnoughReplicas</code>. A program
execution where this monitor gets stuck in the hot state demonstrates a violation of the correctness
property of the replication protocol.</p>
<p>Liveness monitors offer a natural way of describing properties of progress: things that must
<em>eventually</em> happen in the system, where you cannot necessarily say (or its too cumbersome to say)
exactly when the progress will happen. In practice, of course, you cannot wait for infinite
executions: there is only a finite amount of time available to testing. The tester resorts to
heuristics: it considers a sufficiently long and hot execution as a proxy for a liveness violation.
You can configure a bound beyond which executions are considered infinite using the
<code>--liveness-temperature-threshold</code> argument on the <a href="../../get-started/using-coyote/">coyote tool</a>.</p>
<p>Read this <a href="../../how-to/liveness-checking/">how-to guide</a> to learn how to effectively test for
liveness bugs using Coyote.</p>

    <br>
      

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../actors/overview/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../actors/overview/" class="btn btn-xs btn-link">
        Overview
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../binary-rewriting/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../binary-rewriting/" class="btn btn-xs btn-link">
        Binary rewriting for systematic testing
      </a>
    </div>
    
  </div>

      <br>
  </div>
</div>

<footer class="wm-page-content">
  

<section class="footer-join pt-40 pb-80">
  <div class="container-fluid">
    <div class="row text-center">
      <div class="col-sm-8 col-sm-offset-2">
      </div>
    </div>
    <div class="row">
   </div>
  </div>
</section>
<section class="footer-dark pt-60">
  <div class="container-fluid">
    <div class="row">
      <div class="hidden-xs col-sm-5 col-lg-6">
        <a href="" title="homepage" class="logo-footer">
          <img src="/coyote/assets/images/icon.png" alt="Coyote">
        </a>
      </div>

      <div class="col-sm-2 col-xs-4 footer-dark-col">
        <nav>
          <h4>Coyote</h4>
          <ul class="list-unstyled">
            <li><a href="/coyote/">Home</a></li>
            <li><a href="/coyote/get-started/install/">Install</a></li>
            <li><a href="https://github.com/microsoft/coyote/"><i class="fa fa-github"></i>
GitHub</a></li>
          </ul>
        </nav>
      </div>

      <div class="col-sm-2 col-xs-4 footer-dark-col">
        <nav>
          <h4>Resources</h4>
          <ul class="list-unstyled">
            <li><a href="/coyote/tutorials/first-concurrency-unit-test/">Getting started</a></li>
            <li><a href="/coyote/tutorials/overview/">Tutorials</a></li>
            <li><a href="/coyote/ref/Microsoft.Coyote">API documentation</a></li>
          </ul>
        </nav>
      </div>

      <div class="col-sm-2 col-xs-4 footer-dark-col">
        <nav>
          <h4>Community</h4>
          <ul class="list-unstyled">
            <li><a href="https://github.com/microsoft/coyote/discussions"><i class="fa fa-github"></i>
GitHub</a></li>
            <li><a href="https://twitter.com/coyote_dev" target="_blank"><i class="fa fa-twitter"></i> Twitter</a></li>
            <li><a href="https://teams.microsoft.com/l/channel/19%3a1fe966b4fdc544bca648d89bf25c3c56%40thread.tacv2/General?groupId=7a6d8afc-c23d-4e5d-b9cb-9124118c0220&tenantId=72f988bf-86f1-41af-91ab-2d7cd011db47" target="_blank">Teams (Internal)</a></li>
          </ul>
        </nav>
      </div>
    </div>

    <div class="row footnote pt-50 pb-20">
      <div class="col-sm-12">
        <hr>
      </div>
      <div class="col-sm-7">
        <ul class="list-unstyled list-inline footnote-copy">
          <li><a href="https://go.microsoft.com/fwlink/?LinkId=521839" target="_blank">Privacy & Cookies</a></li>
          <li><a href="https://go.microsoft.com/fwlink/?linkid=2259814" target="_blank">Consumer Health Privacy</a></li>
          <li><a href="https://go.microsoft.com/fwlink/?LinkID=206977" target="_blank">Terms of Use</a></li>
          <li><a href="https://www.microsoft.com/en-us/legal/intellectualproperty/trademarks" target="_blank">Trademarks</a></li>
          <li><a href="https://github.com/microsoft/coyote/blob/main/LICENSE" target="_blank">License</a></li>
        </ul>
      </div>
      <div class="col-sm-5 text-right footnote-copy">
        <ul class="list-unstyled list-inline">
          <li><span id="copyright"></span></li>
          <li><a href="https://www.microsoft.com/" target="_blank"><img class="img-responsive" src="/coyote/assets/images/microsoft-logo.svg?v=3" alt="Microsoft">&nbsp;</a></li>
        </ul>
      </div>
    </div>
  </div>
</section>
</footer>


<script type="text/javascript">
    $(document).ready(function () {
      $('table').each(function () {
        $(this).addClass("table");
        $(this).addClass("table-bordered");
        $(this).addClass("table-striped");
        $(this).addClass("table-condensed");
      });

    });
</script>

</body>
</html>