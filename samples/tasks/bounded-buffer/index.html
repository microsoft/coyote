<!DOCTYPE html>
<html lang="en">
<head>
  
  
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    
    <link rel="canonical" href="https://microsoft.github.io/coyote/samples/tasks/bounded-buffer/">
    <link rel="shortcut icon" href="/coyote/img/favicon.ico">
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Deadlock in bounded-buffer - Coyote</title>
    <link href="/coyote/css/bootstrap-3.3.7.min.css" rel="stylesheet">
    <link href="/coyote/css/font-awesome-4.7.0.css" rel="stylesheet">
    <link href="/coyote/css/base.css" rel="stylesheet">
    <link rel="stylesheet" href="/coyote/css/highlight.css">
    <link href="../../../css/main.css" rel="stylesheet">
    <link href="../../../css/player-controls.css" rel="stylesheet">
    <link href="../../../css/syntax.css" rel="stylesheet">
    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->

    <script src="/coyote/js/jquery-3.2.1.min.js"></script>
    <script src="/coyote/js/bootstrap-3.3.7.min.js"></script>
    <script src="/coyote/js/highlight.pack.js"></script>
    <script src="https://consentdeliveryfd.azurefd.net/mscc/lib/v2/wcp-consent.js"></script>
    
    <base target="_top">
    <script>
      var base_url = '/coyote/';
      var is_top_frame = false;
        
        var pageToc = [
          {title: "Deadlock in bounded-buffer", url: "#_top", children: [
          ]},
          {title: "What you will need", url: "#what-you-will-need", children: [
          ]},
          {title: "Build the sample", url: "#build-the-sample", children: [
          ]},
          {title: "Run the bounded-buffer application", url: "#run-the-bounded-buffer-application", children: [
              {title: "Can you find the deadlock bug in BoundedBuffer class?", url: "#can-you-find-the-deadlock-bug-in-boundedbuffer-class" },
          ]},
        ];

    </script>
    <script src="/coyote/js/base.js"></script>
      <script src="../../../assets/js/analytics.js"></script>
      <script src="../../../assets/js/plugins.js"></script>
      <script src="../../../assets/js/animate_trace.js"></script>
      <script src="../../../assets/js/animation.js"></script>
      <script src="../../../assets/js/progress_bar.js"></script>
      <script src="../../../assets/js/trace_model.js"></script>
      <script src="../../../assets/js/main.js"></script>

</head>

<body>
<script>
if (is_top_frame) { $('body').addClass('wm-top-page'); }
</script>

<div id="cookie-banner"></div>


<div class="wrapper wm-page-content">
  <div class="container-fluid">
    <a name="_top"></a>
      

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../../actors/failure-detector/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../../actors/failure-detector/" class="btn btn-xs btn-link">
        Bug in failure detector
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../../overview/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../../overview/" class="btn btn-xs btn-link">
        Overview
      </a>
    </div>
    
  </div>

      

      <h2 id="deadlock-in-bounded-buffer">Deadlock in bounded-buffer</h2>
<p>Concurrent programming can be tricky. This tutorial shows a classic example of a deadlock and how
Coyote can help you find and understand that deadlock. More details about this program and how
Coyote can find this deadlock is found in this <a href="https://cloudblogs.microsoft.com/opensource/2020/07/14/extreme-programming-meets-systematic-testing-using-coyote/">blog
article</a>.</p>
<h2 id="what-you-will-need">What you will need</h2>
<p>To run the <code>BoundedBuffer</code> example, you will need to:</p>
<ul>
<li>Install <a href="https://visualstudio.microsoft.com/downloads/">Visual Studio 2022</a>.</li>
<li>Install the <a href="../../../get-started/install/">.NET 8.0 version of the coyote tool</a>.</li>
<li>Be familiar with the <code>coyote</code> tool. See <a href="../../../get-started/using-coyote/">using Coyote</a>.</li>
<li>Clone the <a href="https://github.com/microsoft/coyote">Coyote git repo</a>.</li>
</ul>
<h2 id="build-the-sample">Build the sample</h2>
<p>You can build the sample by following the instructions
<a href="https://github.com/microsoft/coyote/tree/main/Samples/README.md">here</a>.</p>
<h2 id="run-the-bounded-buffer-application">Run the bounded-buffer application</h2>
<p>Now you can run the <code>BoundedBuffer</code> application in a mode that should trigger the deadlock most of
the time:</p>
<pre><code class="language-plain">./Samples/bin/net8.0/BoundedBuffer.exe -m
</code></pre>
<p>And you can run it with a fix for the deadlock as follows:</p>
<pre><code class="language-plain">./Samples/bin/net8.0/BoundedBuffer.exe -f
</code></pre>
<h3 id="can-you-find-the-deadlock-bug-in-boundedbuffer-class">Can you find the deadlock bug in BoundedBuffer class?</h3>
<p>The BoundedBuffer is a producer consumer queue where the <code>Take</code> method blocks if the buffer is empty
and the <code>Put</code> method blocks if the buffer has reached it&rsquo;s maximum allowed capacity and while the
code looks correct it contains a nasty deadlock bug.</p>
<p>Writing concurrent code is tricky and with the popular <code>async/await</code> feature in the C# Programming
Language it is now extremely easy to write concurrent code.</p>
<p>But how do we test concurrency in our code? Testing tools and frameworks have not kept up with the
pace of language innovation and so this is where <code>Coyote</code> comes to the rescue. When you use Coyote
to test your programs you will find concurrency bugs that are very hard to find any other way.</p>
<p>Coyote rewrites your <code>async tasks</code> in a way that allows the <a href="../../../get-started/using-coyote/">coyote tool</a>
to control all the concurrency and locking in your program and this allows it to find bugs
using intelligent <a href="../../../concepts/concurrency-unit-testing/">systematic testing</a>.</p>
<p>For example, if you take the <code>BoundedBuffer.dll</code> from the above sample you can do the following:</p>
<pre><code>coyote rewrite BoundedBuffer.dll
coyote test BoundedBuffer.dll -m TestBoundedBufferMinimalDeadlock --iterations 100
</code></pre>
<p>This will report a deadlock error because Coyote has deadlock detection during testing. You will get
a log file explaining all this, and more importantly you will also get a trace file that can be used
to replay the bug in your debugger in a way that is 100% reproducible.</p>
<p>Concurrency bugs tend to be the kind of bugs that keep people up late at night pulling their hair
out because they are often not easily reproduced in any sort of predictable manner.</p>
<p>Coyote solves this problem giving you an environment where concurrency bugs can be systematically
found and reliably reproduced in a debugger &ndash; allowing developers to fully understand them and fix
the core problem.</p>

    <br>
      

    
    
      
    

  <div class="row wm-article-nav-buttons" role="navigation" aria-label="navigation">
    
    <div class="wm-article-nav pull-right">
      <a href="../../actors/failure-detector/" class="btn btn-xs btn-default pull-right">
        Next
        <i class="fa fa-chevron-right" aria-hidden="true"></i>
      </a>
      <a href="../../actors/failure-detector/" class="btn btn-xs btn-link">
        Bug in failure detector
      </a>
    </div>
    
    <div class="wm-article-nav">
      <a href="../../overview/" class="btn btn-xs btn-default pull-left">
        <i class="fa fa-chevron-left" aria-hidden="true"></i>
        Previous</a><a href="../../overview/" class="btn btn-xs btn-link">
        Overview
      </a>
    </div>
    
  </div>

      <br>
  </div>
</div>

<footer class="wm-page-content">
  

<section class="footer-join pt-40 pb-80">
  <div class="container-fluid">
    <div class="row text-center">
      <div class="col-sm-8 col-sm-offset-2">
      </div>
    </div>
    <div class="row">
   </div>
  </div>
</section>
<section class="footer-dark pt-60">
  <div class="container-fluid">
    <div class="row">
      <div class="hidden-xs col-sm-5 col-lg-6">
        <a href="" title="homepage" class="logo-footer">
          <img src="/coyote/assets/images/icon.png" alt="Coyote">
        </a>
      </div>

      <div class="col-sm-2 col-xs-4 footer-dark-col">
        <nav>
          <h4>Coyote</h4>
          <ul class="list-unstyled">
            <li><a href="/coyote/">Home</a></li>
            <li><a href="/coyote/get-started/install/">Install</a></li>
            <li><a href="https://github.com/microsoft/coyote/"><i class="fa fa-github"></i>
GitHub</a></li>
          </ul>
        </nav>
      </div>

      <div class="col-sm-2 col-xs-4 footer-dark-col">
        <nav>
          <h4>Resources</h4>
          <ul class="list-unstyled">
            <li><a href="/coyote/tutorials/first-concurrency-unit-test/">Getting started</a></li>
            <li><a href="/coyote/tutorials/overview/">Tutorials</a></li>
            <li><a href="/coyote/ref/Microsoft.Coyote">API documentation</a></li>
          </ul>
        </nav>
      </div>

      <div class="col-sm-2 col-xs-4 footer-dark-col">
        <nav>
          <h4>Community</h4>
          <ul class="list-unstyled">
            <li><a href="https://github.com/microsoft/coyote/discussions"><i class="fa fa-github"></i>
GitHub</a></li>
            <li><a href="https://twitter.com/coyote_dev" target="_blank"><i class="fa fa-twitter"></i> Twitter</a></li>
            <li><a href="https://teams.microsoft.com/l/channel/19%3a1fe966b4fdc544bca648d89bf25c3c56%40thread.tacv2/General?groupId=7a6d8afc-c23d-4e5d-b9cb-9124118c0220&tenantId=72f988bf-86f1-41af-91ab-2d7cd011db47" target="_blank">Teams (Internal)</a></li>
          </ul>
        </nav>
      </div>
    </div>

    <div class="row footnote pt-50 pb-20">
      <div class="col-sm-12">
        <hr>
      </div>
      <div class="col-sm-7">
        <ul class="list-unstyled list-inline footnote-copy">
          <li><a href="https://go.microsoft.com/fwlink/?LinkId=521839" target="_blank">Privacy & Cookies</a></li>
          <li><a href="https://go.microsoft.com/fwlink/?linkid=2259814" target="_blank">Consumer Health Privacy</a></li>
          <li><a href="https://go.microsoft.com/fwlink/?LinkID=206977" target="_blank">Terms of Use</a></li>
          <li><a href="https://www.microsoft.com/en-us/legal/intellectualproperty/trademarks" target="_blank">Trademarks</a></li>
          <li><a href="https://github.com/microsoft/coyote/blob/main/LICENSE" target="_blank">License</a></li>
        </ul>
      </div>
      <div class="col-sm-5 text-right footnote-copy">
        <ul class="list-unstyled list-inline">
          <li><span id="copyright"></span></li>
          <li><a href="https://www.microsoft.com/" target="_blank"><img class="img-responsive" src="/coyote/assets/images/microsoft-logo.svg?v=3" alt="Microsoft">&nbsp;</a></li>
        </ul>
      </div>
    </div>
  </div>
</section>
</footer>


<script type="text/javascript">
    $(document).ready(function () {
      $('table').each(function () {
        $(this).addClass("table");
        $(this).addClass("table-bordered");
        $(this).addClass("table-striped");
        $(this).addClass("table-condensed");
      });

    });
</script>

</body>
</html>